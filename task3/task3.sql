CREATE DATABASE TASK3
GO

USE TASK3
GO

CREATE TABLE TRAM_XANG (
    MATRAMXANG INT IDENTITY(1,1) PRIMARY KEY,
    TENTRAM VARCHAR(50) NOT NULL UNIQUE,
    DIACHI VARCHAR(100) NOT NULL
)

CREATE TABLE HANG_HOA (
    MAHANGHOA INT IDENTITY(1,1) PRIMARY KEY,
    TENHANGHOA VARCHAR(100) NOT NULL UNIQUE
)

CREATE TABLE TRU_BOM (
    MATRUBOM INT IDENTITY(1,1) PRIMARY KEY, 
    MATRAMXANG INT NOT NULL,
    MAHANGHOA INT NOT NULL,
    TENTRUBOM VARCHAR(100) NOT NULL,
    CONSTRAINT FK_TRUBOM_TRAMXANG FOREIGN KEY (MATRAMXANG)
    REFERENCES TRAM_XANG(MATRAMXANG) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT FK_TRUBOM_HANGHOA FOREIGN KEY (MAHANGHOA)
    REFERENCES HANG_HOA(MAHANGHOA) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT UQ_TRUBOM_TENTRUBOM UNIQUE (MATRAMXANG, TENTRUBOM)
)

CREATE TABLE GIAO_DICH (
    MAGIAODICH INT IDENTITY(1,1) PRIMARY KEY,
    MATRUBOM INT NOT NULL,
    NGAYGIO DATETIME NOT NULL CHECK (NGAYGIO <= GETDATE()),
    SOLUONG DECIMAL(10,2) NOT NULL CHECK (SOLUONG > 0),
    GIATRI DECIMAL(15,2) NOT NULL CHECK (GIATRI >= 0),
    CONSTRAINT FK_GIAODICH_TRUBOM FOREIGN KEY (MATRUBOM)
    REFERENCES TRU_BOM(MATRUBOM) ON DELETE CASCADE ON UPDATE CASCADE
)

CREATE INDEX IDX_GIAODICH_MATRUBOM_NGAYGIO ON GIAO_DICH(MATRUBOM, NGAYGIO);
CREATE INDEX IDX_TRUBOM_MATRAMXANG_MATRUBOM ON TRU_BOM(MATRAMXANG, MATRUBOM);
CREATE INDEX IDX_HANGHOA_MAHANGHOA ON HANG_HOA(MAHANGHOA);

-- TRUY VẤN
-- câu 1
SELECT GD.* FROM GIAO_DICH GD JOIN TRU_BOM TB ON GD.MATRUBOM = TB.MATRUBOM
WHERE TB.MATRAMXANG = 1 AND GD.NGAYGIO >= '2023-08-01' AND GD.NGAYGIO < '2023-09-01'
-- câu 2
SELECT CONVERT(DATE, NGAYGIO) AS NGAY, SUM(GIATRI) AS TONGDOANHTHU FROM GIAO_DICH 
WHERE MATRUBOM = 1 GROUP BY CONVERT(DATE, NGAYGIO) ORDER BY NGAY
-- câu 3
SELECT CONVERT(DATE, GD.NGAYGIO) AS NGAY, SUM(GD.GIATRI) AS TONGDOANHTHU
FROM GIAO_DICH GD JOIN TRU_BOM TB ON GD.MATRUBOM = TB.MATRUBOM 
WHERE TB.MATRAMXANG = 1 GROUP BY CONVERT(DATE, GD.NGAYGIO) ORDER BY NGAY
-- câu 4
SELECT TOP 3 HH.MAHANGHOA, HH.TENHANGHOA, SUM(GD.SOLUONG) AS TONGSOLIT FROM GIAO_DICH GD
JOIN TRU_BOM TB ON GD.MATRUBOM = TB.MATRUBOM JOIN HANG_HOA HH ON TB.MAHANGHOA = HH.MAHANGHOA
WHERE TB.MATRAMXANG = 1 AND GD.NGAYGIO >= '2025-08-01' AND GD.NGAYGIO < '2025-09-01'
GROUP BY HH.MAHANGHOA, HH.TENHANGHOA ORDER BY TONGSOLIT DESC

-- DATABASE ẢO ĐỂ TEST
INSERT INTO TRAM_XANG (TENTRAM, DIACHI) VALUES 
('Tram Xang A', '123 Le Loi, Quan 1'),
('Tram Xang B', '456 Nguyen Hue, Quan 3');

INSERT INTO HANG_HOA (TENHANGHOA) VALUES 
('Xang RON 95'),
('Xang E5'),
('Dau DO'),
('Dau FO');

INSERT INTO TRU_BOM (MATRAMXANG, MAHANGHOA, TENTRUBOM) VALUES 
(1, 1, 'Tru bom A1'),
(1, 2, 'Tru bom A2'),
(2, 3, 'Tru bom B1'),
(1, 3, 'Tru bom A3');

INSERT INTO GIAO_DICH (MATRUBOM, NGAYGIO, SOLUONG, GIATRI) VALUES 
(1, '2023-08-01 08:30:00', 10, 250000),
(1, '2023-08-15 14:00:00', 20, 500000),
(2, '2023-08-20 09:15:00', 15, 300000),
(1, '2023-09-01 10:00:00', 12, 260000),
(1, '2023-09-01 11:00:00', 8, 180000),
(1, '2023-09-02 09:30:00', 10, 220000),
(1, '2025-08-05 08:00:00', 30, 750000),
(1, '2025-08-10 10:00:00', 20, 500000),
(2, '2025-08-07 09:00:00', 40, 800000),
(2, '2025-08-21 13:00:00', 10, 200000),
(3, '2025-08-15 08:00:00', 100, 1500000),
(4, '2025-08-12 08:00:00', 25, 600000),
(4, '2025-08-20 09:00:00', 30, 720000);


